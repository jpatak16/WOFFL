---
title: "WOFFL DA"
author: "Jeremy Patak"
output: pdf_document
---

```{r}
library(pacman)
p_load(dplyr, stargazer, data.table, formattable, tidyr, ggplot2, readxl, gganimate, janitor, magrittr, kableExtra, gridExtra, ggalt, forcats, gt)
```

```{r}
#import data set
AllGames = read_excel("WOFFL_stats_portal/AllGames.xlsx", sheet = "All Games") %>%
  clean_names() %>%
  mutate(result = ifelse(score > opponent_score, 1, 0)) %>%
  group_by(ov_wk) %>%
  mutate(ov_wins = order(order(score, decreasing = FALSE)) - 1) %>%
  mutate(ov_losses = order(order(score, decreasing = TRUE)) - 1) %>%
  mutate(opp_ov_wins = order(order(opponent_score, decreasing = FALSE)) - 1) %>%
  mutate(opp_ov_losses = order(order(opponent_score, decreasing = TRUE)) - 1) %>%
  ungroup()
#find current season and current week; CW means last week played
CS = unique(AllGames$season) %>% max()
CW = AllGames %>% filter(season==CS) %>% filter(!is.na(score)) %>% filter(score>0) %>% 
  arrange(desc(week)) %>% select(week) %>% unlist() %>% max()
CW = ifelse(CW == -Inf, 0, CW)
#remove unplayed games
AllGames = AllGames %>% filter(season<CS | (season==CS & week<=CW))

#use for checking player games after entering more seasons
# player_games = AllGames%>% filter(season==2020) %>% select(name = qb_name, team = qb_tm) %>% mutate(pos = 'QB') %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = rb1_name, team = rb1_tm) %>% mutate(pos = 'RB')) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = rb2_name, team = rb2_tm) %>% mutate(pos = 'RB')) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = wr1_name, team = wr1_tm) %>% mutate(pos = 'WR')) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = wr2_name, team = wr2_tm) %>% mutate(pos = 'WR')) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = wr_te_name, team = wr_te_tm, pos = wr_te_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = flex_name, team = flex_tm, pos = flex_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = te_name, team = te_tm) %>% mutate(pos = 'TE')) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = dst_name, team = dst_tm) %>% mutate(pos = 'DST')) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b1_name, team = b1_tm, pos = b1_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b2_name, team = b2_tm, pos = b2_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b3_name, team = b3_tm, pos = b3_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b4_name, team = b4_tm, pos = b4_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b5_name, team = b5_tm, pos = b5_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b6_name, team = b6_tm, pos = b6_pos)) %>%
#   rbind(AllGames %>% filter(season==2020) %>% select(name = b7_name, team = b7_tm, pos = b7_pos)) %>%
#   filter(!is.na(name)) %>%
#   unique()

#test to make sure scores add up to scoring total
# scores = AllGames %>% filter(season==2020) %>%
#   mutate(added_score = qb_pts + rb1_pts + rb2_pts + wr1_pts + wr2_pts + wr_te_pts + te_pts + flex_pts + dst_pts,
#          diff = abs(score - added_score)) %>%
#   select(season, week, team, score, added_score, diff)
```

```{r}
###find record for each team each week

#create columns for records at the time of the matchup
AllGames = AllGames %>% mutate(team_wins = NA, team_losses = NA, opponent_wins = NA, opponent_losses = NA)
#moves columns to relevant order
AllGames = AllGames %>% relocate(team_wins, .after = team) %>% relocate(team_losses, .after = team_wins) %>%
  relocate(opponent_wins, .after = opponent) %>% relocate(opponent_losses, .after = opponent_wins)
#populate columns with records
for(r in 1:nrow(AllGames)){
  #save info needed to find record for each row
  Team = AllGames[[r, 'team']]
  Opponent = AllGames[[r, 'opponent']]
  Season = AllGames[[r, 'season']]
  Week = AllGames[[r, 'week']]
  #find record for team
  prior_games_t = AllGames %>% filter(season==Season) %>% filter(team==Team) %>% filter(week<Week)
  prior_win_t = prior_games_t %>% filter(result==1) %>% nrow() %>% as.numeric()
  prior_loss_t = prior_games_t %>% filter(result==0) %>% nrow() %>% as.numeric()
  #find record for opponent
  prior_games_o = AllGames %>% filter(season==Season) %>% filter(team==Opponent) %>% filter(week<Week)
  prior_win_o = prior_games_o %>% filter(result==1) %>% nrow() %>% as.numeric()
  prior_loss_o = prior_games_o %>% filter(result==0) %>% nrow() %>% as.numeric()
  #populate record cells
  AllGames[r, 'team_wins'] = prior_win_t
  AllGames[r, 'team_losses'] = prior_loss_t
  AllGames[r, 'opponent_wins'] = prior_win_o
  AllGames[r, 'opponent_losses'] = prior_loss_o
}

rm(Team, Opponent, Season, Week, prior_games_t, prior_win_t, prior_loss_t, prior_games_o, prior_win_o, prior_loss_o, r)
```


### Find Lowest Scores Ever
```{r} 
#find lowest scores ever
lowest = AllGames %>% arrange(score)
lowest = lowest %>% select(season, week, reg_po, team, score)
lowest = lowest[1:5,]

lowest %>% kable(col.names = c("Season", "Week", "Regular Season / Playoffs", "Team", "Score"),
          caption = "<span style='font-size:50px'><center>Lowest Scores in a Single Week<center></span>",
          align = 'c') %>%
    kable_styling(full_width = F) %>% 
    column_spec(3, border_right = T)

rm(lowest)
```


### How Many of the Lowest Scores Does Each Team Have
```{r}
#find 50 lowest scores ever and count occurrences by team
lowest = AllGames %>% arrange(score) %>% select(season, week, reg_po, team, score)
lowest = lowest[1:50,] %>% count(team, sort = T)

#find the 50th lowest score ever
lowest50th = AllGames %>% arrange(score) %>% select(season, week, reg_po, team, score) ; lowest50th = lowest50th[[50,5]]

#abbreviate team names so they fit on the plot nicer
lowest$team = abbreviate(lowest$team, minlength = 2, strict = F)

#plot
ggplot(data=lowest) +
  geom_col(mapping= aes(x=reorder(team, -n), y=n, fill=team)) +
  ggtitle('Who has Accounted for the Most Bottom-50 Scores?', paste('The 50th worst score ever was ', lowest50th, ' points.'))+
  xlab('Team') + ylab('Number of Bottom-50 Scores') + theme(legend.position = 'none')

rm(lowest, lowest50th)
```

```{r}
#find 50 lowest scores since 2017 and count occurrences by team
lowest = AllGames %>% filter(season>=2017) %>% arrange(score) %>% select(season, week, reg_po, team, score)
lowest = lowest[1:50,] %>% count(team, sort = T)

#find the 50th lowest score ever
lowest50th = AllGames %>% filter(season>=2017) %>% arrange(score) %>% select(season, week, reg_po, team, score)
lowest50th = lowest50th[[50,5]]

#abbreviate team names so they fit on the plot nicer
lowest$team = abbreviate(lowest$team, minlength = 2, strict = F)

#plot
ggplot(data=lowest) +
  geom_col(mapping= aes(x=reorder(team, -n), y=n, fill=team)) +
  ggtitle('Who has Accounted for the Most Bottom-50 Scores Since 2017?', 
          paste('The 50th worst score since 2017 was ', lowest50th, ' points.')) +
  xlab('Team') + ylab('Number of Bottom-50 Scores') + theme(legend.position = 'none')

rm(lowest, lowest50th)
```


### Average Points Scored Per Season
```{r}
#Total points per season
SeasonPoints = AllGames %>% filter(!is.na(score)) %>% group_by(season) %>% summarize(totalpoints = sum(score))
#total games per season
SeasonGames = AllGames %>% group_by(season) %>% count(result) %>% filter(result==1) %>% mutate(n = n*2) %>% select(season, n)
#combine both df and find ppg
SeasonPoints = left_join(SeasonPoints, SeasonGames, by='season') %>% mutate(ppg = totalpoints/n)
#make the season variable a factor
SeasonPoints$season = as.factor(SeasonPoints$season)

ggplot(data = SeasonPoints) + geom_col(mapping = aes(x=season, y=ppg, fill=season)) +
  ggtitle('WOFFL PPG by Season')+
  xlab('Season') + ylab('PPG') + theme(legend.position = 'none')

rm(SeasonPoints, SeasonGames)
```


### Percentage of Points Scored in a Season
```{r}
SeasonPoints = AllGames %>% filter(!is.na(score)) %>% group_by(season) %>% summarize(totalpoints = sum(score))

#create empty df to fill with desired variables
percentages = data.frame(team=0, season= 0, points=0, percentageOfSeasonPoints=0)
for(i in 1:length(SeasonPoints$season)) {
  #create df with all games in a given season
  SeasonGames = filter(AllGames, season==i+2012)
  #find a list of what players played in a given season
  SeasonPlayers = unique(SeasonGames$team)
  for(j in 1:length(SeasonPlayers)) {
    #find all games played by each player in a given season
    SeasonGamesByPlayer = filter(SeasonGames, team==SeasonPlayers[j])
    #populate row with data we are looking for
    row = c(SeasonPlayers[j], SeasonGames$season[1], sum(SeasonGamesByPlayer$score, na.rm=TRUE), round(sum(SeasonGamesByPlayer$score, na.rm=TRUE)/SeasonPoints[i,2],4)*100)
    #add row to the bottom of our df
    percentages[nrow(percentages) + 1, ] = row
  }
}

#get rid of the first empty row
percentages = percentages[-1,]

#turn points and percentages variables into numeric values
percentages$points = as.numeric(percentages$points)
percentages$percentageOfSeasonPoints = as.numeric(percentages$percentageOfSeasonPoints)

#remove seth and nike's split team from 2016
percentages = percentages %>% filter(!(season==2016 & team=="Nike Simmons" | season==2016 & team=="Seth Lassiter"))

#order by percent and put into table
percentages %<>% arrange(percentageOfSeasonPoints)
formattable(percentages[1:10,],
            align = 'l')

#percentages sorted the other way
percentages %<>% arrange(desc(percentageOfSeasonPoints))
formattable(percentages[1:10,],
            align = 'l')
```


### How often does each Team Score More Than 10% of the Season Point Total
```{r}
#find how many times each team got more than 10 percent in a season
allteams = unique(AllGames$team)
over10 = data.frame(team=unique(AllGames$team), SeasonsOver10=0, TotalSeasons=0)
for(k in 1:length(allteams)){
  #filter percentage df to team of interest
  namefilter= filter(percentages, team==allteams[k])
  #populate how many times the given team played a season
  over10[k,3]= nrow(namefilter)
  #filter the teams seasons to only seasons where they scored more than 10% of the points
  namefilter2 = filter(namefilter, percentageOfSeasonPoints>10)
  #populate the df with how many times they scored more than 10% of the points
  over10[k,2]= nrow(namefilter2)
}

#create a new column showing percent of times each team scored more than 10% of the total points
over10$percent = round(over10$SeasonsOver10 / over10$TotalSeasons , 4) * 100
over10 = over10 %>% arrange(desc(percent))
formattable(over10,
            align = 'l')

rm(namefilter, namefilter2, over10, percentages, row, SeasonGames, SeasonGamesByPlayer, SeasonPoints, allteams, i, j, k, SeasonPlayers)
```

### Current Overall Wins Standings
```{r}
#create empty df for wins by week data
wins_by_week = data.frame(Wk=NA, Team=NA, Wins=NA)[0,]

#the for loop will populate the wins by week data frame one team at a time
for(t in unique(AllGames$team)){
  #empty data frame for each team to start with
  wins_by_week_t = data.frame(wk=NA, team=NA, wins=NA)[0,]
  #find all games played by each team
  list_games = AllGames %>% filter(team==t)
  #populate first row of wins by week data frame
  wins_by_week_t[1,] = c(1, t, ifelse(list_games$ov_wk[1]==1,
                                      list_games$result[1],
                                      0))
  #for loop to populate the rest of the rows
  for(w in 2:max(AllGames$ov_wk)){
    #find game for team t in week w
    game = list_games %>% filter(ov_wk==w)
    #decides if team t played a game in week w or not
    pg = ifelse(nrow(game)>0, 
                ifelse(is.na(game$opponent), 0, 1), 0)
    #decides if team t won in week w or not
    win = as.numeric(ifelse(pg>0, game$result[1], 0))
    #figures out how many all time wins team t already had
    previous_wins = as.numeric(wins_by_week_t[w-1,3])
    #populates the row for week w based on how many wins team t has now
    wins_by_week_t[w,] = c(w, t, previous_wins+win)
  }
  #combines all teams into one df
  wins_by_week = rbind(wins_by_week, wins_by_week_t)
}

wins_by_week$wk = as.numeric(wins_by_week$wk)
wins_by_week$wins = as.numeric(wins_by_week$wins)

rm(game, list_games, wins_by_week_t, pg, previous_wins, t, w, win)
```

```{r}
#plot wins by week
wins_by_week = wins_by_week %>%
  #add current rank for each team each week
  group_by(wk) %>%
  mutate(rank = rank(-wins, ties.method = "first"),
         Value_rel = wins/wins[rank==1]) %>%
  filter(rank<=10)

staticplot = ggplot(wins_by_week, aes(rank, group = team,
                fill = as.factor(team), color = as.factor(team))) +
  geom_tile(aes(y = wins/2,
                height = wins,
                width = 0.9), alpha = 0.8, color = NA) +
  geom_text(aes(y = 0, label = paste(team, " ")), vjust = 0.2, hjust = 1) +
  geom_text(aes(y=wins, label = scales::number(as.numeric(wins), acc = 1)), hjust=0) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color = FALSE, fill = FALSE) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
         axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
        plot.margin = margin(2,2, 2, 4, "cm"))

anim = staticplot + transition_states(wk, transition_length = 4, state_length = 1, wrap = FALSE) +
  view_follow(fixed_x = TRUE)  +
  labs(title = 'WOFFL All Time Wins Race',
       subtitle  =  "Weeks since 2013 Season Started : {closest_state}")

#animate the bar graph
#animate(anim, fps = 20, duration = 30,  width = 1200, height = 1000, end_pause = 120, renderer = gifski_renderer("gganim.gif"))

rm(anim, staticplot, wins_by_week)
```

```{r}
#static version of the plot
AllTimeWins = AllGames %>% group_by(team) %>% summarise(wins = sum(result, na.rm = T)) %>% arrange(desc(wins))
AllTimeWins = AllTimeWins[1:10,]

ggplot(AllTimeWins) + geom_col(aes(x=reorder(team, wins), y=wins, fill=team)) +
  coord_flip() + theme(legend.position = 'none') + xlab("") + ylab("All-Time Wins") +
  ggtitle("WOFFL All-Time Wins Leaders")

rm(AllTimeWins)
```

### Current Wins Standings Since 2017
```{r}
#create empty df for wins by week data
wins_by_week = data.frame(Wk=NA, Team=NA, Wins=NA)[0,]

#make the final product be since 2017
Since2017 = AllGames %>% filter(season>=2017)

#the for loop will populate the wins by week data frame one team at a time
for(t in unique(Since2017$team)){
  #empty data frame for each team to start with
  wins_by_week_t = data.frame(wk=NA, team=NA, wins=NA)[0,]
  #find all games played by each team
  list_games = Since2017 %>% filter(team==t)
  #populate first row of wins by week data frame
  wins_by_week_t[1,] = c(1, t, ifelse(list_games$ov_wk[1]==61,
                                      list_games$result[1],
                                      0))
  #for loop to populate the rest of the rows
  for(w in 62:max(Since2017$ov_wk)){
    #find game for team t in week w
    game = list_games %>% filter(ov_wk==w)
    #decides if team t played a game in week w or not
    pg = ifelse(nrow(game)>0, 
                ifelse(is.na(game$opponent), 0, 1), 0)
    #decides if team t won in week w or not
    win = as.numeric(ifelse(pg>0, game$result[1], 0))
    #figures out how many all time wins team t already had
    previous_wins = as.numeric(wins_by_week_t[w-61,3])
    #populates the row for week w based on how many wins team t has now
    wins_by_week_t[w-60,] = c(w-60, t, previous_wins+win)
  }
  #combines all teams into one df
  wins_by_week = rbind(wins_by_week, wins_by_week_t)
}

wins_by_week$wk = as.numeric(wins_by_week$wk)
wins_by_week$wins = as.numeric(wins_by_week$wins)

rm(game, list_games, wins_by_week_t, pg, previous_wins, t, w, win)
```

```{r}
#plot wins by week
wins_by_week = wins_by_week %>%
  #add current rank for each team each week
  group_by(wk) %>%
  mutate(rank = rank(-wins, ties.method = "first"),
         Value_rel = wins/wins[rank==1]) %>%
  filter(rank<=10)

staticplot = ggplot(wins_by_week, aes(rank, group = team,
                fill = as.factor(team), color = as.factor(team))) +
  geom_tile(aes(y = wins/2,
                height = wins,
                width = 0.9), alpha = 0.8, color = NA) +
  geom_text(aes(y = 0, label = paste(team, " ")), vjust = 0.2, hjust = 1) +
  geom_text(aes(y=wins, label = scales::number(as.numeric(wins), acc = 1)), hjust=0) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color = FALSE, fill = FALSE) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
         axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
        plot.margin = margin(2,2, 2, 4, "cm"))

anim = staticplot + transition_states(wk, transition_length = 4, state_length = 1, wrap = FALSE) +
  view_follow(fixed_x = TRUE)  +
  labs(title = 'WOFFL Wins Since the Start of 2017 Season',
       subtitle  =  "Weeks since 2017 Season Started : {closest_state}")

#animate the bar graph
#animate(anim, fps = 20, duration = 30,  width = 1200, height = 1000, end_pause = 120, renderer = gifski_renderer("gganim.gif"))

rm(anim, staticplot, wins_by_week)
```

```{r}
#static version of the plot
WinsSince2017 = Since2017 %>% group_by(team) %>% summarise(wins = sum(result, na.rm = T)) %>% arrange(desc(wins))
WinsSince2017 = WinsSince2017[1:10,]

ggplot(WinsSince2017) + geom_col(aes(x=reorder(team, wins), y=wins, fill=team)) +
  coord_flip() + theme(legend.position = 'none') + xlab("") + ylab("Wins Since 2017") +
  ggtitle("WOFFL Win Leaders Since 2017")

rm(WinsSince2017)
```

### Current Overall Points Standings
```{r}
#create empty df for points by week data
points_by_week = data.frame(Wk=NA, Team=NA, Points=NA)[0,]

#the for loop will populate the points by week data frame one team at a time
for(t in unique(AllGames$team)){
  #empty data frame for each team to start with
  points_by_week_t = data.frame(wk=NA, team=NA, Points=NA)[0,]
  #find all games played by each team
  list_games = AllGames %>% filter(team==t)
  #populate first row of points by week data frame
  points_by_week_t[1,] = c(1, t, ifelse(list_games$ov_wk[1]==1,
                                      list_games$score[1],
                                      0))
  #for loop to populate the rest of the rows
  for(w in 2:max(AllGames$ov_wk)){
    #find game for team t in week w
    game = list_games %>% filter(ov_wk==w)
    #decides if team t played a game in week w or not
    pg = ifelse(nrow(game)>0, 
                ifelse(is.na(game$opponent), 0, 1), 0)
    #decides team t score in week w or not
    score = as.numeric(ifelse(pg>0, game$score[1], 0))
    #figures out how many all time points team t already had
    previous_points = as.numeric(points_by_week_t[w-1,3])
    #populates the row for week w based on how many points team t has now
    points_by_week_t[w,] = c(w, t, previous_points+score)
  }
  #combines all teams into one df
  points_by_week = rbind(points_by_week, points_by_week_t)
}

points_by_week$wk = as.numeric(points_by_week$wk)
points_by_week$Points = as.numeric(points_by_week$Points)

rm(game, list_games, points_by_week_t, pg, previous_points, t, w, score)
```

```{r}
#plot points by week
points_by_week = points_by_week %>%
  #add current rank for each team each week
  group_by(wk) %>%
  mutate(rank = rank(-Points, ties.method = "first"),
         Value_rel = Points/Points[rank==1],
         Value_lbl = paste0("",round(Points, 0))) %>%
  filter(rank<=10)

staticplot = ggplot(points_by_week, aes(rank, group = team,
                fill = as.factor(team), color = as.factor(team))) +
  geom_tile(aes(y = Points/2,
                height = Points,
                width = 0.9), alpha = 0.8, color = NA) +
  geom_text(aes(y = 0, label = paste(team, " ")), vjust = 0.2, hjust = 1) +
  geom_text(aes(y=Points, label = Value_lbl), hjust=0) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color = FALSE, fill = FALSE) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
         axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
        plot.margin = margin(2,2, 2, 4, "cm"))

anim = staticplot + transition_states(wk, transition_length = 4, state_length = 1, wrap = FALSE) +
  view_follow(fixed_x = TRUE)  +
  labs(title = 'WOFFL All Time Points Race',
       subtitle  =  "Weeks since 2013 Season Started : {closest_state}")

#animate the bar graph
#animate(anim, fps = 20, duration = 45,  width = 1200, height = 1000, end_pause = 120, renderer = gifski_renderer("gganim.gif"))

rm(anim, staticplot, points_by_week)
```

```{r}
#static version of the plot
AllTimePoints = AllGames %>% group_by(team) %>% summarise(points = sum(score, na.rm = T)) %>% arrange(desc(points))
AllTimePoints = AllTimePoints[1:10,]

ggplot(AllTimePoints) + geom_col(aes(x=reorder(team, points), y=points, fill=team)) +
  coord_flip() + theme(legend.position = 'none') + xlab("") + ylab("All-Time Points") +
  ggtitle("WOFFL All-Time Points Leaders")

rm(AllTimePoints)
```


### Current Points Standings Since 2017
```{r}
#create empty df for points by week data
points_by_week = data.frame(Wk=NA, Team=NA, Points=NA)[0,]

#the for loop will populate the points by week data frame one team at a time
for(t in unique(Since2017$team)){
  #empty data frame for each team to start with
  points_by_week_t = data.frame(wk=NA, team=NA, Points=NA)[0,]
  #find all games played by each team
  list_games = Since2017 %>% filter(team==t)
  #populate first row of points by week data frame
  points_by_week_t[1,] = c(1, t, ifelse(list_games$ov_wk[1]==61,
                                      list_games$score[1],
                                      0))
  #for loop to populate the rest of the rows
  for(w in 62:max(Since2017$ov_wk)){
    #find game for team t in week w
    game = list_games %>% filter(ov_wk==w)
    #decides if team t played a game in week w or not
    pg = ifelse(nrow(game)>0, 
                ifelse(is.na(game$opponent), 0, 1), 0)
    #decides score of team t in week w
    score = as.numeric(ifelse(pg>0, game$score[1], 0))
    #figures out how many all time points team t already had
    previous_points = as.numeric(points_by_week_t[w-61,3])
    #populates the row for week w based on how many points team t has now
    points_by_week_t[w-60,] = c(w-60, t, previous_points+score)
  }
  #combines all teams into one df
  points_by_week = rbind(points_by_week, points_by_week_t)
}

points_by_week$wk = as.numeric(points_by_week$wk)
points_by_week$Points = as.numeric(points_by_week$Points)

rm(game, list_games, points_by_week_t, pg, previous_points, t, w, score)
```

```{r}
#plot points by week
points_by_week = points_by_week %>%
  #add current rank for each team each week
  group_by(wk) %>%
  mutate(rank = rank(-Points, ties.method = "first"),
         Value_rel = Points/Points[rank==1],
         Value_lbl = paste0("",round(Points, 0))) %>%
  filter(rank<=10)

staticplot = ggplot(points_by_week, aes(rank, group = team,
                fill = as.factor(team), color = as.factor(team))) +
  geom_tile(aes(y = Points/2,
                height = Points,
                width = 0.9), alpha = 0.8, color = NA) +
  geom_text(aes(y = 0, label = paste(team, " ")), vjust = 0.2, hjust = 1) +
  geom_text(aes(y=Points, label = Value_lbl), hjust=0) +
  coord_flip(clip = "off", expand = FALSE) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_reverse() +
  guides(color = FALSE, fill = FALSE) +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
         axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.x = element_line( size=.1, color="grey" ),
        panel.grid.minor.x = element_line( size=.1, color="grey" ),
        plot.title=element_text(size=25, hjust=0.5, face="bold", colour="grey", vjust=-1),
        plot.subtitle=element_text(size=18, hjust=0.5, face="italic", color="grey"),
        plot.caption =element_text(size=8, hjust=0.5, face="italic", color="grey"),
        plot.background=element_blank(),
        plot.margin = margin(2,2, 2, 4, "cm"))

anim = staticplot + transition_states(wk, transition_length = 4, state_length = 1, wrap = FALSE) +
  view_follow(fixed_x = TRUE)  +
  labs(title = 'WOFFL Points Scored Since the Start of 2017 Season',
       subtitle  =  "Weeks since 2017 Season Started : {closest_state}")

#animate the bar graph
#animate(anim, fps = 20, duration = 30,  width = 1200, height = 1000, end_pause = 120, renderer = gifski_renderer("gganim.gif"))

rm(anim, staticplot, points_by_week)
```

```{r}
#static version of the plot
PointsSince2017 = Since2017 %>% group_by(team) %>% summarise(points = sum(score, na.rm = T)) %>% arrange(desc(points))
PointsSince2017 = PointsSince2017[1:10,]

ggplot(PointsSince2017) + geom_col(aes(x=reorder(team, points), y=points, fill=team)) +
  coord_flip() + theme(legend.position = 'none') + xlab("") + ylab("Points Scored Since 2017") +
  ggtitle("WOFFL Points Scored Leaders Since 2017")

rm(PointsSince2017)
```


### Wk1 Scores vs Season PF
```{r}
#creates df of teams that have won a championship
champ = AllGames %>% group_by(season) %>% filter(week==15 | week==16 & season>=2021) %>% filter(!(week==15 & season>=2021)) %>% filter(elim=="Yes") %>% group_by(team, season) %>% summarize(championship = sum(result)) %>% filter(championship==1)

#creates a df of all Wk1 performances excluding any ongoing season
Wk1 = AllGames %>% filter(week==1) %>% filter(season %in% champ$season) %>%
  select(season, team, score)
#drop 2016 Nike because he didn't finish the season
Wk1 = Wk1[!(Wk1$team=='Nike Simmons' & Wk1$season==2016),]

#creates a df of PF for each team each season
#removes week 13 in 2021 because all other seasons had only 12 weeks
#doesn't include the 2022 season because it is still ongoing
SeasonTotal = AllGames %>% filter(AllGames[,'reg_po']=="Regular Season") %>% filter (week <= 13) %>% filter(!is.na(score)) %>% group_by(team, season) %>% summarize(ppg= mean(score)) %>% filter(season %in% champ$season)
#removes observations for Seth and Nike in 2016 since they split a team
SeasonTotal = SeasonTotal[!(SeasonTotal$team=='Nike Simmons' & SeasonTotal$season==2016),]
SeasonTotal = SeasonTotal[!(SeasonTotal$team=='Seth Lassiter' & SeasonTotal$season==2016),]

#combines the championship, Wk1, and season total dfs
Wk1_PF = left_join(Wk1, SeasonTotal, by=c('season'='season', 'team'='team'))
Wk1_PF = left_join(Wk1_PF, champ, by=c('season'='season', 'team'='team'))
Wk1_PF = Wk1_PF %>% mutate(championship = ifelse(is.na(championship), 0, 1)) #assigns a 0 to teams that didn't win a championship

#plots Wk1 score vs season PF
ggplot(Wk1_PF, mapping = aes(x=ppg, y=score)) + geom_point(aes(color=as.factor(championship))) + geom_smooth(method = 'lm', se=FALSE) +
  ggtitle("Does Week 1 Score Correlate to Regular Season Points Total?") + xlab("Season Points Total") + ylab('Week 1 Score') +
  theme_light() +
  scale_color_manual(values = c("0" = "black", "1" = "gold")) +
  theme(legend.position = 'none')

rm(Wk1_PF, SeasonTotal, Wk1)  
```


### Highest/Lowest Scoring in a Week with X overall Wins
```{r}
scoring_records_by_weekly_placement = function(pos, highest=TRUE, n=5){
  pos = pos-1
  #players who scored the xth amount of points in a week
  filtered = AllGames %>% filter(ov_losses==pos)
  #orders rows
  filtered = filtered[order(filtered$score, decreasing = highest),]
  #takes out rows with bye weeks
  filtered = filtered %>% mutate(ov_games = ov_wins + ov_losses) %>% filter(ov_games==9)
  #takes the top n rows
  filtered = filtered[1:n,]
  #picks the columns we want in our table and changes column names to upper case
  filtered = filtered %>% select(team, season, week, score, result) %>% mutate(result = ifelse(result==1, "Win", "Loss"))
  names(filtered) <- toupper(names(filtered))
  
  #correct number sound for pos in title
  if(pos+1==1){sound = "st "}
  else if(pos+1==2){sound = "nd "}
  else if(pos+1==3){sound = "rd "}
  else{sound = "th "}
  
  #creates a caption for our table
  capt = paste("<span style='font-size:30px'><center>", ifelse(highest==TRUE, "Highest", "Lowest"), " Ever Scores by the ", pos+1, 
               sound, "Highest Scoring Team of the Week<center></span>", sep = "")
  
  #formats our table
  filtered %>% 
    kable(caption = capt) %>%
    kable_styling(full_width = F) %>% 
    column_spec(4, bold = T, border_left = T, border_right = T) %>% 
    column_spec(5, background = ifelse(filtered$RESULT=='Win', "Green", "Red"))
}

scoring_records_by_weekly_placement(pos = 2, highest = FALSE, n=10)
```



### Worst Start Through x Weeks
```{r}
worst_start = function(weeks, n=5){
  #gets a list of all teams that played each season and their total points for the season
  worst_starts = AllGames %>% filter(AllGames$reg_po == "Regular Season") %>% 
    group_by(team, season) %>% summarize(Reg_Season_Points=sum(score))
  #removes observations for Seth and Nike in 2016 since they split a team
  worst_starts = worst_starts[!(worst_starts$team=='Nike Simmons' & worst_starts$season==2016),]
  worst_starts = worst_starts[!(worst_starts$team=='Seth Lassiter' & worst_starts$season==2016),]
  
  games_played = c()
  bad_starts = c()
  wins = c()
  for(r in 1:nrow(worst_starts)){
    team_var = worst_starts[[r,1]]
    season_var = worst_starts[[r,2]]
    games = AllGames %>% filter(team==team_var) %>% filter(season==season_var) %>% filter(reg_po == "Regular Season")
    gp = as.numeric(nrow(games))
    games_played[r] = gp
    first_weeks = games %>% filter(week<=weeks)
    n_weeks_total_score = sum(first_weeks$score)
    n_weeks_wins = sum(first_weeks$result)
    bad_starts[r] = n_weeks_total_score
    wins[r] = n_weeks_wins
  }
  worst_starts$points_in_first_n_weeks = bad_starts
  worst_starts$wins_in_first_n_weeks = wins
  worst_starts$gp = games_played
  worst_starts$Reg_Season_PPG = round(worst_starts$Reg_Season_Points / worst_starts$gp, digits=1)
  worst_starts = worst_starts %>% filter(gp>=weeks) %>% mutate(Reg_Season_PPG = ifelse(gp==weeks, NA, Reg_Season_PPG)) %>% 
    select(team, season, points_in_first_n_weeks, wins_in_first_n_weeks, Reg_Season_PPG)
  worst_starts = worst_starts[order(worst_starts$points_in_first_n_weeks, decreasing = FALSE),]
  worst_starts = worst_starts[1:n,]
  
  worst_starts %>% 
    kable(col.names = c("Team", "Season", paste("PTS through ", weeks, " Weeks", sep = ""), paste("Wins through ", weeks, " Weeks", sep = ""),
                        "Regular Season PPG"),
          caption = paste("<span style='font-size:50px'><center>Worst Ever Starts to a Season Through Week ", weeks, "<center></span>", 
                          sep = "")) %>%
    kable_styling(full_width = F) %>% 
    column_spec(3, border_left = T) %>% 
    column_spec(4, border_right = T)
}

worst_start(6, n=10)
```

### 0 Win vs 0 Loss Teams
```{r}

zero_win_vs_zero_loss = AllGames %>% filter(week > 2) %>% filter(team_losses==0) %>% filter(opponent_wins==0)

rm(zero_win_vs_zero_loss)

```


### Longest Undefeated Streak To Open A Season
```{r}
longest_undefeated = AllGames %>% filter(team_losses==0) %>% arrange(desc(team_wins)) %>% filter(result==0) %>% filter(team_wins>2) %>%
  select(season, team, team_wins, team_losses, opponent, opponent_wins, opponent_losses, score, opponent_score) %>%
  mutate(losing_margin = score - opponent_score) %>% select(-score, -opponent_score) %>%
  mutate(record = paste(team_wins, team_losses, sep = '-')) %>% mutate(opponent_record = paste(opponent_wins, opponent_losses, sep = '-')) %>%
  select(season, team, record, opponent, opponent_record, losing_margin)

longest_undefeated %>% 
    kable(col.names = c("Season", "Team", "W-L to Start Season", "Next Opponent", "Opponent Record", "Losing Margin"),
          caption = "<span style='font-size:50px'><center>Best Undefeated Streaks to Start a Season and Their End<center></span>") %>%
    kable_styling(full_width = F) %>% 
    column_spec(3, border_right = T) %>% 
    row_spec(8, bold=T)
```


### Most Times Scoring Top x in a Week
```{r}
topx_freq = function(x, since2017=FALSE){
  #how many times finishing top x in a week per team
  n = AllGames %>% filter(ov_losses<x) %>% count(team)
  if(since2017==TRUE){n = n %>% filter(season>2016)}

  #how many weeks played per team
  gp = AllGames %>% count(team) %>% rename(gp=n)
  if(since2017==TRUE){gp = gp %>% filter(season>2016)}

  #join tables
  topn_frac = left_join(n, gp, by='team')

  #add column for percentage of times placed in top 3
  topn_frac = topn_frac %>% mutate(freq = n / gp) %>% arrange(desc(freq)) %>% mutate(freq = round(freq, digits = 3))
  
  #find current league members to use in the output table
  current = AllGames %>% arrange(desc(season), desc(week)); current = current[1:10, 'team']; current = current$team
  
  #make output table
  capt = paste("<span style='font-size:40px'><center>","Who Scores in the Top ", x, " with the Highest Frequency?","<center></span>", sep = '')
  color_rows = which(topn_frac$team %in% current)
  topn_frac %>% kable(caption = capt) %>% kable_styling(full_width = F) %>% column_spec(4, bold = T, border_left = T) %>%
    row_spec(color_rows, background = "#F1E5AC")
}

topx_freq(4)
```


### Difference in PF 5 Weeks In
```{r}
#find points scored through a given week
afterweek5 = AllGames %>% filter(week<6) %>% group_by(season, team) %>% summarize(PF = sum(score)) %>% arrange(season, desc(PF))
#rank each team in PF through the given week
vec = rep(1:10, times=length(unique(AllGames$season)))
afterweek5$PFrank = vec
#put the first place team and fourth place team each season in the same row
first = afterweek5 %>% filter(PFrank == 1) ; fourth = afterweek5 %>% filter(PFrank == 4)
afterweek5 = left_join(first, fourth, by='season') %>% mutate(diff = PF.x-PF.y) %>% select(season, team.x, PF.x, team.y, PF.y, diff) %>%
  arrange(diff)

#display results
afterweek5 %>% kable(col.names = c("Season", "First In Points", "Points", "Fourth in Points", "Points", "Difference"),
          caption = "<span style='font-size:50px'><center>Closest PF Races Through 5 Weeks<center></span>") %>%
    kable_styling(full_width = F) %>% 
    column_spec(3, border_right = T) %>%  column_spec(5, border_right = T) %>%  column_spec(1, border_right = T) %>% 
    row_spec(1, bold=T)

rm(afterweek5, first, fourth, vec)
```


### Compare Record to Overall Wins
```{r}
#find all 4-1 teams
teams4_1 = AllGames %>% filter(team_wins+result==4) %>% filter(team_losses+ifelse(result==1, 0, 1)==1) %>% select(season, team, team_wins, team_losses, result) %>% mutate(team_wins = team_wins+result) %>% mutate(team_losses = 1) %>% select(!result)

#find PF for all teams through week 5
afterweek5 = AllGames %>% filter(week<6) %>% group_by(season, team) %>% summarize(PF = sum(score)) %>% arrange(season, desc(PF))

#add PF as a column in the df of 4-1 teams
teams4_1 = left_join(teams4_1, afterweek5, by=c('season', 'team'))

#find overall wins for all teams through week 5 and add them as a column in the df of 4-1 teams
afterweek5 = AllGames %>% filter(week<6) %>% group_by(season, team) %>% summarize(ov_wins = sum(ov_wins))
teams4_1 = left_join(teams4_1, afterweek5, by=c('season', 'team'))

#find overall losses for all teams through week 5 and add them as a column in the df of 4-1 teams
afterweek5 = afterweek5 = AllGames %>% filter(week<6) %>% group_by(season, team) %>% summarize(ov_losses = sum(ov_losses))
teams4_1 = left_join(teams4_1, afterweek5, by=c('season', 'team'))

#combine overall wins and losses into a record column
teams4_1 = teams4_1 %>% arrange(desc(ov_wins)) %>% mutate(ov_record = paste(ov_wins, "-", ov_losses, sep = "")) %>%
  select(season, team, PF, ov_record)

#display results
teams4_1 %>% kable(col.names = c("Season", "Team", "Points", "Overall Record"),
          caption = "<span style='font-size:50px'><center>Evaluating all of the 4-1 Teams in League History<center></span>",
          align = 'c') %>%
    kable_styling(full_width = F) %>% 
    column_spec(2, border_right = T) %>%
    row_spec(14, bold=T, color = "#765705")


rm(afterweek5, teams4_1)
```


### Set Perfect Lineup
```{r}
SetPerfectLineup = function(df){
  end_res = data.frame(season = NA, week = NA, team = NA, perfect_score = NA, subs_for_perfect = NA)
  for(r in 1:nrow(df)){
    #skip row if no player level data
    if(is.na(df[r,'qb_name'])){next}
    #basic info
    tm = df[[r,'team']]
    szn = df[[r,'season']]
    wk = df[[r,'week']]
    #empty df for a list of players
    player_list = data.frame(Name= NA, Pos = NA, Pts = NA); player_list = player_list[-1,]
    #list of players and their score
    #the teams list of players for the week
    player_list[1,2] = "QB"; player_list[1,3] = df[r, 'qb_pts']; player_list[1,1] = df[r, 'qb_name']
    player_list[2,2] = "RB"; player_list[2,3] = df[r, 'rb1_pts']; player_list[2,1] = df[r, 'rb1_name']
    player_list[3,2] = "RB"; player_list[3,3] = df[r, 'rb2_pts']; player_list[3,1] = df[r, 'rb2_name']
    player_list[4,2] = "WR"; player_list[4,3] = df[r, 'wr1_pts']; player_list[4,1] = df[r, 'wr1_name']
    player_list[5,2] = "WR"; player_list[5,3] = df[r, 'wr2_pts']; player_list[5,1] = df[r, 'wr2_name']
    player_list[6,2] = "TE"; player_list[6,3] = df[r, 'te_pts']; player_list[6,1] = df[r, 'te_name']
    player_list[7,2] = "DST"; player_list[7,3] = df[r, 'dst_pts']; player_list[7,1] = df[r, 'dst_name']
    player_list[8,2] = df[r,'wr_te_pos']; player_list[8,3] = df[r, 'wr_te_pts']; player_list[8,1] = df[r, 'wr_te_name']
    player_list[9,2] = df[r,'flex_pos']; player_list[9,3] = df[r, 'flex_pts']; player_list[9,1] = df[r, 'flex_name']
    original_starters = player_list$Name
    player_list[10,2] = df[r,'b1_pos']; player_list[10,3] = df[r, 'b1_pts']; player_list[10,1] = df[r, 'b1_name']
    player_list[11,2] = df[r,'b2_pos']; player_list[11,3] = df[r, 'b2_pts']; player_list[11,1] = df[r, 'b2_name']
    player_list[12,2] = df[r,'b3_pos']; player_list[12,3] = df[r, 'b3_pts']; player_list[12,1] = df[r, 'b3_name']
    player_list[13,2] = df[r,'b4_pos']; player_list[13,3] = df[r, 'b4_pts']; player_list[13,1] = df[r, 'b4_name']
    player_list[14,2] = df[r,'b5_pos']; player_list[14,3] = df[r, 'b5_pts']; player_list[14,1] = df[r, 'b5_name']
    player_list[15,2] = df[r,'b6_pos']; player_list[15,3] = df[r, 'b6_pts']; player_list[15,1] = df[r, 'b6_name']
    player_list[16,2] = df[r,'b7_pos']; player_list[16,3] = df[r, 'b7_pts']; player_list[16,1] = df[r, 'b7_name']
    player_list = player_list %>% filter(!is.na(Pos))
    #fill out a perfect roster
    perfect_roster = data.frame(Name=NA, Pos=NA, Pts=NA); perfect_roster = perfect_roster[-1,]
    perfect_roster[1,2] = "QB"; a = player_list %>% filter(Pos=="QB") %>% arrange(desc(Pts)); perfect_roster[1,3] = a[[1,3]]; perfect_roster[1,1] = a[[1,1]]
    perfect_roster[2,2] = "RB1"; a = player_list %>% filter(Pos=="RB") %>% arrange(desc(Pts)); perfect_roster[2,3] = a[[1,3]]; perfect_roster[2,1] = a[[1,1]]
    perfect_roster[3,2] = "RB2"; a = player_list %>% filter(Pos=="RB") %>% arrange(desc(Pts)); perfect_roster[3,3] = a[[2,3]]; perfect_roster[3,1] = a[[2,1]]
    perfect_roster[4,2] = "WR1"; a = player_list %>% filter(Pos=="WR") %>% arrange(desc(Pts)); perfect_roster[4,3] = a[[1,3]]; perfect_roster[4,1] = a[[1,1]]
    perfect_roster[5,2] = "WR2"; a = player_list %>% filter(Pos=="WR") %>% arrange(desc(Pts)); perfect_roster[5,3] = a[[2,3]]; perfect_roster[5,1] = a[[2,1]]
    perfect_roster[7,2] = "TE"; a = player_list %>% filter(Pos=="TE") %>% arrange(desc(Pts)); perfect_roster[7,3] = a[[1,3]]; perfect_roster[7,1] = a[[1,1]]
    perfect_roster[9,2] = "DST"; a = player_list %>% filter(Pos=="DST") %>% arrange(desc(Pts)); perfect_roster[9,3] = a[[1,3]]; perfect_roster[9,1] = a[[1,1]]
    #remove players we already used before selecting flex positions for the perfect lineup
    still_available = data.frame(Name = setdiff(player_list$Name, perfect_roster$Name))
    player_list = left_join(still_available, player_list, by="Name")
    perfect_roster[6,2] = "WR/TE"; a = player_list %>% filter(Pos=="WR" | Pos=="TE") %>% arrange(desc(Pts)); perfect_roster[6,3] = a[[1,3]]; perfect_roster[6,1] = a[[1,1]]
    still_available = data.frame(Name = setdiff(player_list$Name, perfect_roster$Name))
    player_list = left_join(still_available, player_list, by="Name")
    perfect_roster[8,2] = "FLEX"; a = player_list %>% filter(Pos=="WR" | Pos=="TE" | Pos=="RB") %>% arrange(desc(Pts)) 
    perfect_roster[8,3] = a[[1,3]]; perfect_roster[8,1] = a[[1,1]]
    #replace any negative score with 0 because they would be better off if the player was benched
    for(i in 1:nrow(perfect_roster)){perfect_roster[i,1] = ifelse(perfect_roster[i,3]<0, "BENCHED", perfect_roster[i,1])}
    for(i in 1:nrow(perfect_roster)){perfect_roster[i,3] = ifelse(perfect_roster[i,3]<0, 0, perfect_roster[i,3])}
    #find how much the perfect lineup would have scored
    perfect_score = perfect_roster %>% summarise(score=sum(Pts, na.rm = T)); perfect_score = perfect_score[[1,1]]
    subs_for_perfect = length(setdiff(original_starters, perfect_roster$Name)) %>% as.numeric()
    #add results to df
    end_res[r,1] = szn
    end_res[r,2] = wk
    end_res[r,3] = tm
    end_res[r,4] = perfect_score
    end_res[r,5] = subs_for_perfect
  }
  df = left_join(df, end_res, by=c('season', 'week', 'team'))
  return(df)
}

#AllGames = SetPerfectLineup(AllGames) %>% relocate(perfect_score, .after = score) %>% relocate(subs_for_perfect, .after = perfect_score)
```


### Possible Points vs PF
```{r fig.width=8, fig.height=15}
#find how teams did compared to perfect and projected scores
AllGames = AllGames %>% 
  mutate(projection = qb_proj + rb1_proj + rb2_proj + wr1_proj + wr2_proj + wr_te_proj + te_proj + flex_proj + dst_proj)
PL = AllGames %>% filter(season==2019) %>% 
  select(season, week, team, score, projection, perfect_score, subs_for_perfect) %>% group_by(team) %>% 
  summarise(projection = sum(projection), score = sum(score), perfect_score = sum(perfect_score), subs_for_perfect = sum(subs_for_perfect)) %>%
  mutate(percent_of_projection = round((score / projection)*100, digits = 2), 
         percent_of_perfect = round((score / perfect_score)*100, digits = 2),
         points_left_on_bench = perfect_score-score) %>%
  relocate(points_left_on_bench, .after=score)

#pivot longer so we can make a stacked bar chart
PL2 = PL %>% select(team, score, points_left_on_bench) %>% pivot_longer(!team, names_to = 'type', values_to = 'points')
#abbreviate team names so they fit on the x axis nicer
PL2$team = abbreviate(PL2$team, minlength = 2, strict = F)
#pull values for our text on the stacked bar chart
PL3 = PL %>% select(team, score, percent_of_perfect)
#abbreviate those names so we can match them to PL2
PL3$team = abbreviate(PL3$team, minlength = 2, strict = F)
#join PL2 and PL3 to have all data needed in the PL2 set
PL2 = full_join(PL2, PL3)
#set the order for the bars on the x axis of the graph
o = PL2 %>% filter(type == "score") %>% arrange(desc(points)) %>% extract2("team")
PL2 = PL2 %>% mutate(team = factor(team, o))

#plot
ggplot(PL2, aes(x=team, y=points, fill=type)) + geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(labels = c('PPP', 'PF'), values = c('red', 'dark green')) +
  ggtitle("How Good of Lineups Do You Set?", subtitle = "Through 6 Weeks of the 2022 WOFFL Season") +
  xlab("Team") + ylab("Points") +
  geom_text(data = PL2, aes(x=team, y=score, label=round(percent_of_perfect,1)), color='white', nudge_y = -10) +
  theme_minimal() + theme(legend.position = 'top',
                          legend.title = element_blank())
  

rm(PL, PL2, PL3, o)

```


### Records if Everyone Always Set Their Perfect Lineup
```{r}
a = AllGames %>% filter(season==2019) %>% filter(reg_po=="Regular Season") %>% select(season, week, team, score, perfect_score, opponent, opponent_score)
opp_perfect_scores = c()
for(r in 1:nrow(a)){
  wk = a[[r,2]]
  opp = a[[r,6]]
  opp_ps = a %>% filter(week == wk) %>% filter(team == opp) %>% .[[1, 5]]
  opp_perfect_scores[r] = opp_ps
}
a$opponent_perfect_score = opp_perfect_scores

a$perfect_result = ifelse(a$perfect_score > a$opponent_perfect_score, 1, 0)

a = a %>% group_by(team) %>% summarise(wins = sum(perfect_result))
a$losses = wk-a$wins

a %>% kable()

rm(a, opp, opp_perfect_scores, opp_ps, r, wk)
```


### Score Distributions
```{r fig.width=4, fig.height=15}
#who played last week?
lastweek = AllGames %>% filter(season == max(AllGames$season)); lastweek = lastweek %>% filter(week == max(lastweek$week))
lastweek = lastweek$team

#manually add another variable to signify upcoming match ups and facets
AllGames_temp = AllGames %>% 
  mutate(matchup = ifelse(team=="Austin Iske"|team=="Jeremy Patak", "Iske vs Jeremy", 0)) %>%
  mutate(matchup = ifelse(team=="Seth Lassiter"|team=="Nike Simmons", "Seth vs Nike", matchup)) %>%
  mutate(matchup = ifelse(team=="Daniel Potichko"|team=="Nick McFarland", "Daniel vs Nick", matchup)) %>%
  mutate(matchup = ifelse(team=="Landry Sheridan"|team=="Brody Morgan", "Landry vs Brody", matchup)) %>%
  mutate(matchup = ifelse(team=="Stone Palmer"|team=="Dax Davis", "Stone vs Dax", matchup))

AllGames_temp <- split(AllGames_temp,f = AllGames_temp$matchup)

p1 = ggplot(AllGames_temp$`Daniel vs Nick` %>% filter(team %in% lastweek), aes(x=score, fill=team, color=team)) + 
  geom_density(alpha=.1) +
  facet_wrap(~matchup, ncol = 1) +
  xlim(30,170) + ylim(0,.025) +
  theme_bw() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank())

p2 = p1 %+% AllGames_temp$`Iske vs Jeremy`
p3 = p2 %+% AllGames_temp$`Landry vs Brody`
p4 = p3 %+% AllGames_temp$`Seth vs Nike`
p5 = p4 %+% AllGames_temp$`Stone vs Dax`

grid.arrange(p1, p2, p3, p4, p5, ncol=1)

rm(AllGames_temp, p1, p2, p3, p4, p5, lastweek)
```


### Weekly Scoring Recap
```{r}
ggplot(AllGames %>% filter(season==2022)) + geom_boxplot(aes(x=week, y=score, group=week)) + 
  geom_path(data = AllGames %>% filter(season==2022) %>% group_by(week) %>% summarise(PF = sum(score)),
            aes(x=week, y=PF/5), size=3, color="red", alpha=.5) + theme_bw() + 
  theme(panel.grid = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  xlab("Week") + ylab("Score") +
  scale_x_continuous(breaks = c(1:nrow(AllGames %>% filter(season==2022) %>% group_by(week) %>% summarise(PF = sum(score)))))
```


### How Do Bad Teams Finish the Season
```{r}
a = AllGames %>% filter(week<=8) %>% group_by(team, season) %>% summarise(ppg = mean(score))
b = AllGames %>% filter(week>8) %>% filter(reg_po == "Regular Season") %>% group_by(team, season) %>% summarise(ppg = mean(score))

ppg_b4_and_after_w9 = left_join(b, a, by= c('team', 'season')) %>% select(team, season, ppg_b4_wk9 = ppg.y, ppg_after_wk9 = ppg.x) %>%
  left_join(champ, by=c("team", "season")) %>% mutate(championship = ifelse(is.na(championship), 0, 1))

ggplot(data = ppg_b4_and_after_w9, aes(x=ppg_b4_wk9, y=ppg_after_wk9)) + geom_point(aes(color=as.factor(championship))) +
  scale_color_manual(values = c("0" = "black", "1" = "gold")) +
  geom_smooth(method = 'lm', se=F, formula = y~poly(x,2)) +
  theme_bw() +
  xlab("PPG Weeks 1-8") + ylab("PPG Week 9 to End of Regular Season") +
  ggtitle("Can You Turn Your Season Around This Late?") +
  theme(legend.position = 'none')

rm(a,b,ppg_b4_and_after_w9)
```

### Schedule Luck Quantified (One Season)
```{r}
luckAG = AllGames %>% filter(season==CS) %>% filter(week<=CW) %>% filter(reg_po=="Regular Season") %>%
  select(season, week, team, score, opponent, opponent_score, result, ov_wins, ov_losses) %>%
  mutate(x_wp = ov_wins/9) %>% 
  group_by(team) %>%
  summarise(wins = sum(result), x_wins = sum(x_wp)) %>%
  mutate(luck = wins - x_wins)


scores2022 = AllGames %>% filter(season==CS) %>% filter(week<=CW) %>% filter(reg_po=="Regular Season") %>% 
  select(season, week, team, score)
sims = data.frame(sim_num = NA, team = NA, x_wins = NA); sims = sims[-1,]
for(sim in 1:100){
  for(t in luckAG$team){
    s = AllGames %>% filter(season==CS) %>% filter(week<=CW) %>% filter(reg_po=="Regular Season") %>% filter(team==t) %>%
      select(season, week, team, score, opponent, opponent_score, result)
    new_sched = sample(s$opponent)
    s$opponent = new_sched
    s$opponent_score = NA
    s = left_join(s, scores2022, by=c("season", "week", "opponent"="team")) %>%
      rename(score=score.x, opp_score=score.y) %>%
      select(season, week, team, score, opponent, opp_score) %>%
      mutate(result = ifelse(score>opp_score, 1, 0))
    line = data.frame(sim_num = sim, team = t, x_wins =sum(s$result))
    sims = rbind(sims, line)
  }
}
a = sims %>% group_by(team) %>% summarise(x_wins2 = mean(x_wins)) 
luckAG = full_join(luckAG, a, by=c('team')) %>% mutate(luck2 = wins - x_wins2) %>%
  arrange(desc(wins))

rm(scores2022, sims, s, line, a, new_sched, sim, t)
```

##### Schedule Luck All Seasons
```{r}
AllSeasonLuck = function(){
  
  years = unique(AllGames$season)
  
  Luck = data.frame(season=NA, team=NA, wins=NA, x_wins=NA, luck=NA, x_wins2=NA, luck2=NA)
  Luck = Luck[-1,]
  
  AllGames_fixed = AllGames %>% mutate(team = ifelse(season==2016&team=="Nike Simmons", "Seth Lassiter", team))
  
  for(y in years){
  
    luckAG = AllGames_fixed %>% filter(season==y) %>% filter(week<=CW) %>% filter(reg_po=="Regular Season") %>%
      select(season, week, team, score, opponent, opponent_score, result, ov_wins, ov_losses) %>%
      mutate(x_wp = ov_wins/9) %>% 
      group_by(team) %>%
      summarise(wins = sum(result), x_wins = sum(x_wp)) %>%
      mutate(luck = wins - x_wins)

    scores2022 = AllGames_fixed %>% filter(season==y) %>% filter(week<=CW) %>% filter(reg_po=="Regular Season") %>% 
      select(season, week, team, score)
    sims = data.frame(sim_num = NA, team = NA, x_wins = NA); sims = sims[-1,]
    for(sim in 1:100){
      for(t in luckAG$team){
        s = AllGames_fixed %>% filter(season==y) %>% filter(week<=CW) %>% filter(reg_po=="Regular Season") %>% filter(team==t) %>%
          select(season, week, team, score, opponent, opponent_score, result) %>% 
          mutate(opponent = ifelse(season==2016&opponent=="Nike Simmons", "Seth Lassiter", opponent))
        new_sched = sample(s$opponent)
        s$opponent = new_sched
        s$opponent_score = NA
        s = left_join(s, scores2022, by=c("season", "week", "opponent"="team")) %>%
          rename(score=score.x, opp_score=score.y) %>%
          select(season, week, team, score, opponent, opp_score) %>%
          mutate(result = ifelse(score>opp_score, 1, 0))
        line = data.frame(sim_num = sim, team = t, x_wins =sum(s$result))
        sims = rbind(sims, line)
      }
      }
    a = sims %>% group_by(team) %>% summarise(x_wins2 = mean(x_wins)) 
    luckAG = full_join(luckAG, a, by=c('team')) %>% mutate(luck2 = wins - x_wins2) %>%
      arrange(desc(wins)) %>% mutate(season=y) %>% relocate(.before = team)
    
    Luck=rbind(Luck, luckAG)
    
  }
  return(Luck)
  }

#a = AllSeasonLuck()
```


### Positional Breakdown
```{r fig.width=5, fig.height=5}
pos_breakdown = AllGames %>% filter(season==CS) %>% filter(reg_po!='BYE') %>% group_by(team) %>% 
  summarise(QB = mean(qb_pts),
            RB = mean(rb1_pts) + mean(rb2_pts),
            WR = mean(wr1_pts) + mean(wr2_pts), 
            TE = mean(te_pts),
            WR_TE= mean(wr_te_pts),
            FLEX = mean(flex_pts),
            DST = mean(dst_pts),
            PF = mean(score)) %>%
  arrange(desc(PF)) %>%
  mutate(QB = round(QB, 1),
         RB = round(RB, 1),
         WR = round(WR, 1), 
         TE = round(TE, 1),
         WR_TE = round(WR_TE, 1),
         FLEX = round(FLEX, 1),
         DST = round(DST, 1),
         PF = round(PF, 1))

#pivot longer so we can make a stacked bar chart
pos_breakdown2 = pos_breakdown %>% 
  pivot_longer(!team, names_to = 'pos', values_to = 'ppg') %>% filter(pos!='PF')
#abbreviate team names so they fit on the x axis nicer
pos_breakdown2$team = abbreviate(pos_breakdown2$team, minlength = 2, strict = F)


ggplot(pos_breakdown2, aes(x=team, y=ppg, fill=factor(pos, levels = c('QB', 'RB', 'WR', 'TE', 'WR_TE', 'FLEX', 'DST')))) +
  geom_bar(position = "stack", stat = "identity") +
  ggtitle("WOFFL Positional Breakdown") +
  xlab("") + ylab("PPG") +
  theme_minimal() + theme(legend.position = 'right',
                          legend.title = element_blank())

pos_breakdown %>% 
  kable(caption = "2022 WOFFL Positional Breakdown (Per Game)") %>%
  kable_styling(full_width = F, position = 'center') %>%
  column_spec(1, border_right = T) %>%
  column_spec(9, border_left = T) %>%
  column_spec(2, color='white', background = spec_color(pos_breakdown$QB, option = "D")) %>%
  column_spec(3, color='white', background = spec_color(pos_breakdown$RB, option = "D")) %>%
  column_spec(4, color='white', background = spec_color(pos_breakdown$WR, option = "D")) %>%
  column_spec(5, color='white', background = spec_color(pos_breakdown$TE, option = "D")) %>%
  column_spec(6, color='white', background = spec_color(pos_breakdown$WR_TE, option = "D")) %>%
  column_spec(7, color='white', background = spec_color(pos_breakdown$FLEX, option = "D")) %>%
  column_spec(8, color='white', background = spec_color(pos_breakdown$DST, option = "D"))
  

```
